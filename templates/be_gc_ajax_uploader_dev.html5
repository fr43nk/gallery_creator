<?php  $GLOBALS['TL_JAVASCRIPT'][] = '../system/modules/gallery_creator/assets/plugins/bla.js'; ?>
<?php
$url = sprintf("contao/main.php?do=gallery_creator&id=%s&act=edit&table=tl_gallery_creator_albums&mode=fileupload&rt=%s", $this->Input->get('id'), REQUEST_TOKEN);
?>


    <input type="file" name="image" id="filesToUpload" onchange="javascript:showSelectedFiles();" multiple><br />
    <button type="button" id="btn" onclick="javascript:return sendRequest(); return false;">Upload</button>
    <ul id="fileList"></ul>
        <a href="contao/main.php?do=gallery_creator&id=178&act=edit&table=tl_gallery_creator_albums&mode=fileupload&rt=450ba8130a19890ff6499347e860eaf5&ref=40b7a497">link</a>
<script>

    function showSelectedFiles()
    {
            //get the input and UL list
            var input = document.getElementById('filesToUpload');
            var list = document.getElementById('fileList');

            //empty list for now...
            $$('#fileList li').each(function(el,index){
                el.destroy();
            });

            //for every file...
            for (var x = 0; x < input.files.length; x++) {
                //add to list
                var li = document.createElement('li');
                li.innerHTML = 'File ' + (x + 1) + ':  ' + input.files[x].name;
                li.inject(list);
            }

    }


    //http://www.html5rocks.com/de/tutorials/file/xhr2/
    function sendRequest(){
        var oMyForm = new FormData();
        var fileInputObject = document.id('filesToUpload').files;

        Object.each(fileInputObject,function(el,index)
        {
            if(el.name == undefined)return;
            if(!el.name)return;
            if(el.name == 'undefined')return;
            if(el.name == '')return;

            //alert(el.name);
            oMyForm.append("FORM_SUBMIT", "tl_gallery_creator_albums");
            oMyForm.append("REQUEST_TOKEN", "<?php echo REQUEST_TOKEN; ?>");
            oMyForm.append("BE_USER_AUTH", "<?php echo $_COOKIE['BE_USER_AUTH']; ?>");

            oMyForm.append("BE_USER_AUTH", "<?php echo $_COOKIE['BE_USER_AUTH']; ?>");
            oMyForm.append("BE_USER_AUTH", "<?php echo $_COOKIE['BE_USER_AUTH']; ?>");


            // HTML file input user's choice...
            oMyForm.append("file", el);



            var oReq = new XMLHttpRequest();
            //oReq.withCredentials = true;
            oReq.open("POST", "<?php echo $url; ?>");
            oReq.addEventListener("progress", updateProgress, false);
            oReq.addEventListener("load", transferComplete, false);
            oReq.addEventListener("error", transferFailed, false);
            oReq.addEventListener("abort", transferCanceled, false);
            oReq.send(oMyForm);
        });
        document.id('filesToUpload').value = '';
        return false;

    }

    // progress on transfers from the server to the client (downloads)
    function updateProgress (oEvent) {
        if (oEvent.lengthComputable) {
            var percentComplete = oEvent.loaded / oEvent.total;
            // ...
        } else {
            // Unable to compute progress information since the total size is unknown
        }
    }

    function transferComplete(evt) {
        alert("The transfer is complete.");
    }

    function transferFailed(evt) {
        alert("An error occurred while transferring the file.");
    }

    function transferCanceled(evt) {
        alert("The transfer has been canceled by the user.");
    }

</script>